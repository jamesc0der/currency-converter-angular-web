<mat-card class="converter-card">
  <mat-card-header>
    <mat-card-title>Convert Currency</mat-card-title>
  </mat-card-header>
  
  <mat-card-content>
    <form [formGroup]="converterForm" (ngSubmit)="convert()">
      <!-- Main Converter Row: Amount + From + To -->
      <div class="converter-row">
        <!-- Amount Input -->
        <div class="amount-field">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Amount</mat-label>
            <input 
              matInput 
              type="number" 
              formControlName="amount"
              appCurrencyInput
              placeholder="1.00">
            @if (converterForm.get('amount')?.hasError('required')) {
              <mat-error>Amount is required</mat-error>
            }
            @if (converterForm.get('amount')?.hasError('min')) {
              <mat-error>Amount must be greater than 0</mat-error>
            }
          </mat-form-field>
        </div>

        <!-- Currency Conversion Group -->
        <div class="currency-conversion-group">
          <!-- From Currency -->
          <div class="currency-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>From</mat-label>
              <input 
                #fromInput
                matInput
                formControlName="fromCurrencySearch"
                [matAutocomplete]="autoFrom"
                (click)="fromInput.select()"
                placeholder="Search currency...">
              <mat-autocomplete 
                #autoFrom="matAutocomplete"
                (optionSelected)="selectFromCurrency($event.option.value)"
                [displayWith]="displayCurrency.bind(this)">
                @for (currency of filteredFromCurrencies$ | async; track currency.code) {
                  <mat-option [value]="currency.code">
                    {{ currency.code }} - {{ currency.name }}
                  </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <!-- Swap Button -->
          <div class="swap-container">
            <button 
              mat-mini-fab 
              color="accent" 
              type="button"
              (click)="swapCurrencies()"
              aria-label="Swap currencies">
              <mat-icon>swap_horiz</mat-icon>
            </button>
          </div>

          <!-- To Currency -->
          <div class="currency-field">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>To</mat-label>
              <input 
                #toInput
                matInput
                formControlName="toCurrencySearch"
                [matAutocomplete]="autoTo"
                (click)="toInput.select()"
                placeholder="Search currency...">
              <mat-autocomplete 
                #autoTo="matAutocomplete"
                (optionSelected)="selectToCurrency($event.option.value)"
                [displayWith]="displayCurrency.bind(this)">
                @for (currency of filteredToCurrencies$ | async; track currency.code) {
                  <mat-option [value]="currency.code">
                    {{ currency.code }} - {{ currency.name }}
                  </mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Second Row: Date + Convert button -->
      <div class="bottom-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Historical Date (Optional)</mat-label>
          <input 
            matInput 
            [matDatepicker]="picker"
            formControlName="date"
            [max]="maxDate"
            placeholder="Select date for historical rate">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-hint>Leave empty for current rate</mat-hint>
        </mat-form-field>
  
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          class="convert-btn"
          [disabled]="converterForm.invalid || (loading$ | async)">
          @if (!(loading$ | async)) {
            <span>Convert</span>
          }
          @if (loading$ | async) {
            <mat-spinner diameter="20"></mat-spinner>
          }
        </button>
      </div>
    </form>

    <!-- Result Display -->
    @if (convertedAmount !== null && !((loading$ | async))) {
      <div class="result-container">
        <div class="result">
          <div class="result-amount">
            {{ converterForm.get('amount')?.value | number:'1.2-2' }} 
            {{ converterForm.get('fromCurrency')?.value }}
            =
          </div>
          <div class="result-converted">
            {{ convertedAmount | number:'1.2-2' }} 
            {{ converterForm.get('toCurrency')?.value }}
          </div>
          @if (exchangeRate) {
            <div class="result-rate">
              Rate: 1 {{ converterForm.get('fromCurrency')?.value }} = 
              {{ exchangeRate | number:'1.4-4' }} {{ converterForm.get('toCurrency')?.value }}
            </div>
          }
        </div>
      </div>
    }
  </mat-card-content>
</mat-card>
